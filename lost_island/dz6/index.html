<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AR Чотирикутник на маркерах</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.6.0/math.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        a-scene {
            width: 100%;
            height: 100vh;
        }
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            max-width: 300px;
            z-index: 10000;
        }
        .marker-label {
            font-size: 0.5em;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.2em;
            border-radius: 0.2em;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <a-scene mindar-image="imageTargetSrc: targets.mind; autoStart: true;" vr-mode-ui="enabled: false">
        <a-assets>
            <img id="markerA" src="markerA.png">
            <img id="markerB" src="markerB.png">
            <img id="markerC" src="markerC.png">
            <img id="markerD" src="markerD.png">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- Маркер A -->
        <a-entity mindar-image-target="targetIndex: 0">
            <a-plane src="#markerA" width="0.5" height="0.5" position="0 0 0" rotation="-90 0 0"></a-plane>
            <a-entity position="0 0.01 0" text="value: A; align: center; color: white; width: 5" class="marker-label"></a-entity>
        </a-entity>

        <!-- Маркер B -->
        <a-entity mindar-image-target="targetIndex: 1">
            <a-plane src="#markerB" width="0.5" height="0.5" position="0 0 0" rotation="-90 0 0"></a-plane>
            <a-entity position="0 0.01 0" text="value: B; align: center; color: white; width: 5" class="marker-label"></a-entity>
        </a-entity>

        <!-- Маркер C -->
        <a-entity mindar-image-target="targetIndex: 2">
            <a-plane src="#markerC" width="0.5" height="0.5" position="0 0 0" rotation="-90 0 0"></a-plane>
            <a-entity position="0 0.01 0" text="value: C; align: center; color: white; width: 5" class="marker-label"></a-entity>
        </a-entity>

        <!-- Маркер D -->
        <a-entity mindar-image-target="targetIndex: 3">
            <a-plane src="#markerD" width="0.5" height="0.5" position="0 0 0" rotation="-90 0 0"></a-plane>
            <a-entity position="0 0.01 0" text="value: D; align: center; color: white; width: 5" class="marker-label"></a-entity>
        </a-entity>

        <!-- Лінії між маркерами -->
        <a-entity id="lines"></a-entity>

        <!-- Панель інформації -->
        <div id="info-panel">
            <h3>Геометричні обчислення</h3>
            <p id="perimeter">Периметр: -</p>
            <p id="areas">Площі трикутників: -</p>
        </div>
    </a-scene>

    <script>
        // Масив для зберігання позицій маркерів
        const markerPositions = {
            A: null,
            B: null,
            C: null,
            D: null
        };

        // Функція для оновлення позицій маркерів
        function updateMarkerPositions() {
            document.querySelectorAll('[mindar-image-target]').forEach((entity, index) => {
                const position = entity.object3D.position;
                const markerName = ['A', 'B', 'C', 'D'][index];
                markerPositions[markerName] = {x: position.x, y: position.y, z: position.z};
            });
            
            updateLinesAndCalculations();
        }

        // Функція для оновлення ліній та обчислень
        function updateLinesAndCalculations() {
            const linesContainer = document.getElementById('lines');
            linesContainer.innerHTML = '';
            
            // Перевірка, чи всі маркери виявлені
            const allMarkersDetected = Object.values(markerPositions).every(pos => pos !== null);
            
            if (!allMarkersDetected) {
                document.getElementById('perimeter').textContent = "Периметр: не всі маркери виявлені";
                document.getElementById('areas').textContent = "Площі трикутників: не всі маркери виявлені";
                return;
            }
            
            // Масив точок для зручності
            const points = [
                markerPositions.A,
                markerPositions.B,
                markerPositions.C,
                markerPositions.D,
                markerPositions.A // Замикаємо чотирикутник
            ];
            
            // Відображення ліній між маркерами
            for (let i = 0; i < points.length - 1; i++) {
                const start = points[i];
                const end = points[i+1];
                
                // Обчислюємо середину між точками
                const midpoint = {
                    x: (start.x + end.x) / 2,
                    y: (start.y + end.y) / 2,
                    z: (start.z + end.z) / 2
                };
                
                // Обчислюємо довжину лінії
                const length = Math.sqrt(
                    Math.pow(end.x - start.x, 2) + 
                    Math.pow(end.y - start.y, 2) + 
                    Math.pow(end.z - start.z, 2)
                );
                
                // Обчислюємо кут нахилу лінії
                const angle = Math.atan2(
                    end.z - start.z,
                    end.x - start.x
                ) * (180 / Math.PI);
                
                // Створюємо лінію
                const line = document.createElement('a-entity');
                line.setAttribute('geometry', {
                    primitive: 'cylinder',
                    radius: 0.01,
                    height: length
                });
                line.setAttribute('material', {
                    color: '#00FF00',
                    opacity: 0.8
                });
                line.setAttribute('position', {
                    x: midpoint.x,
                    y: midpoint.y + 0.01, // Трохи вище маркерів
                    z: midpoint.z
                });
                line.setAttribute('rotation', {
                    x: 0,
                    y: -angle + 90,
                    z: 0
                });
                
                linesContainer.appendChild(line);
            }
            
            // Обчислення периметра
            let perimeter = 0;
            const sides = [];
            
            for (let i = 0; i < 4; i++) {
                const start = points[i];
                const end = points[(i+1)%4];
                const sideLength = Math.sqrt(
                    Math.pow(end.x - start.x, 2) + 
                    Math.pow(end.y - start.y, 2) + 
                    Math.pow(end.z - start.z, 2)
                );
                sides.push(sideLength);
                perimeter += sideLength;
            }
            
            document.getElementById('perimeter').textContent = `Периметр: ${perimeter.toFixed(2)} м`;
            
            // Обчислення площ трикутників
            const triangles = [
                ['A', 'B', 'C'],
                ['A', 'B', 'D'],
                ['A', 'C', 'D'],
                ['B', 'C', 'D']
            ];
            
            let areasText = "Площі трикутників:<br>";
            
            triangles.forEach(triangle => {
                const [a, b, c] = triangle;
                const p1 = markerPositions[a];
                const p2 = markerPositions[b];
                const p3 = markerPositions[c];
                
                // Довжини сторін трикутника
                const ab = Math.sqrt(
                    Math.pow(p2.x - p1.x, 2) + 
                    Math.pow(p2.y - p1.y, 2) + 
                    Math.pow(p2.z - p1.z, 2)
                );
                
                const bc = Math.sqrt(
                    Math.pow(p3.x - p2.x, 2) + 
                    Math.pow(p3.y - p2.y, 2) + 
                    Math.pow(p3.z - p2.z, 2)
                );
                
                const ca = Math.sqrt(
                    Math.pow(p1.x - p3.x, 2) + 
                    Math.pow(p1.y - p3.y, 2) + 
                    Math.pow(p1.z - p3.z, 2)
                );
                
                // Формула Герона
                const s = (ab + bc + ca) / 2;
                const area = Math.sqrt(s * (s - ab) * (s - bc) * (s - ca));
                
                areasText += `${a}${b}${c}: ${area.toFixed(2)} м²<br>`;
            });
            
            document.getElementById('areas').innerHTML = areasText;
        }

        // Оновлюємо позиції кожні 100 мс
        setInterval(updateMarkerPositions, 100);
    </script>
</body>
</html>
