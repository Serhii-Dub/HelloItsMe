<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–æ–¥ —Å—Ç–∞—î —Ä–µ–∞–ª—å–Ω—ñ—Å—Ç—é | AR-–≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ–≥—Ä–∞–º</title>
  <link rel="stylesheet" href="assets/style.css" />

  <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-image-three.umd.js"></script>

  <!-- –ü—Ä–æ—Ñ—ñ–ª—é–≤–∞–Ω–Ω—è (ML) -->
  <script src="ml/profile_optimizer.js" defer></script>
</head>
<body>
  <div class="container">
    <h1>üîç –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∑ –∫–æ–¥–æ–º –ø—Ä–æ–≥—Ä–∞–º–∏</h1>
    <div id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR...</div>
    <div id="ar-container" style="display: none;"></div>
    <div id="code-visualization">
      <pre id="code-display">// –¢—É—Ç –±—É–¥–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—å –∫–æ–¥</pre>
      <div id="variables-panel">
        <h3>üì¶ –°—Ç–∞–Ω –∑–º—ñ–Ω–Ω–∏—Ö:</h3>
        <ul id="variable-list"></ul>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('load', async () => {
      try {
        if (!window.MINDAR || !window.THREE) {
          throw new Error("–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å");
        }

        const mindar = new window.MINDAR.IMAGE.MindARThree({
          container: document.getElementById("ar-container"),
          imageTargetSrc: "lib/targets.mind",
        });

        const { renderer, scene, camera } = mindar;

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0, 0, 1);
        scene.add(light);

        mindar.onTargetFound = (targetIdx) => {
          console.log("–ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ:", targetIdx);
          const programCode = getProgramCode(targetIdx);
          visualizeCodeExecution(programCode);
        };

        await mindar.start();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('ar-container').style.display = 'block';

        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });

        // === –ö–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–∏ ===
        function getProgramCode(markerId) {
          const programs = [
`// –ü—Ä–æ–≥—Ä–∞–º–∞ 1: –°—É–º–∞ —á–∏—Å–µ–ª
let sum = 0;
for (let i = 1; i <= 5; i++) {
    sum += i;
}
console.log(sum);`,

`// –ü—Ä–æ–≥—Ä–∞–º–∞ 2: –†–µ–∫—É—Ä—Å–∏–≤–Ω–∏–π —Ñ–∞–∫—Ç–æ—Ä—ñ–∞–ª
function factorial(n) {
    if (n <= 1) return 1;
    return n * factorial(n - 1);
}
let result = factorial(5);`
          ];
          return programs[markerId] || "// –ö–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
        }

        function visualizeCodeExecution(code) {
          const lines = code.split('\n');
          let lineIdx = 0;
          const context = {};
          const variableList = document.getElementById("variable-list");
          variableList.innerHTML = "";

          const interval = setInterval(() => {
            if (lineIdx >= lines.length) {
              clearInterval(interval);
              // ML –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
              if (typeof optimizeCode === "function") {
                optimizeCode(code);
              }
              return;
            }

            highlightLine(lineIdx, lines);

            const currentLine = lines[lineIdx].trim();
            try {
              if (currentLine && !currentLine.startsWith("//")) {
                // –ü—Ä–æ—Å—Ç–∏–π "sandboxed eval" ‚Äî eval —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ –æ–±'—î–∫—Ç–∞
                const func = new Function("ctx", `
                  with(ctx) {
                    ${currentLine}
                  }
                `);
                func(context);
              }
            } catch (err) {
              console.warn("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ —Ä—è–¥–∫–∞:", err.message);
            }

            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∑–º—ñ–Ω–Ω–∏—Ö
            variableList.innerHTML = Object.keys(context).map(k => {
              return `<li><strong>${k}</strong>: ${JSON.stringify(context[k])}</li>`;
            }).join("");

            lineIdx++;
          }, 1000);
        }

        function highlightLine(lineNumber, lines) {
          const codeDisplay = document.getElementById("code-display");
          codeDisplay.innerHTML = lines.map((line, idx) => {
            return `<div class="${idx === lineNumber ? 'highlight-line' : ''}">${line}</div>`;
          }).join('\n');
        }

      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞:", error);
        document.getElementById("loading").innerHTML = `
          <div class="error">
            <h3>üö® –ü–æ–º–∏–ª–∫–∞ AR</h3>
            <p>${error.message}</p>
            <p>–î–ª—è GitHub Pages –æ–±–æ–≤'—è–∑–∫–æ–≤–æ:</p>
            <ul>
              <li>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ HTTPS</li>
              <li>–§–∞–π–ª targets.mind –º–∞—î –±—É—Ç–∏ –º–µ–Ω—à–µ 10MB</li>
              <li>–ë—Ä–∞—É–∑–µ—Ä Chrome –Ω–∞ Android/iOS</li>
            </ul>
            <p><a href="https://serhii-dub.github.io/your-repo/" target="_blank">–ü–æ–≤–Ω–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</a></p>
          </div>
        `;
      }
    });
  </script>
</body>
</html>
